<!DOCTYPE html>
<html>
    <head>
        <title>UKz14 - a map for walking</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="leaflet.css"/>
        <script src="leaflet.js"></script>

        <style>
            html, body {
                width: 100%;
				height: 100%;
                margin: 0;
                padding: 0;
            }
			#map {
				width: 100%;
				height: calc(100% - 50px);
			}
			#header {
				width: calc(100% - 30px);
				height: 20px;
				padding: 15px;
				line-height: 20px;
				font-size: 20px;
				font-family: "Verdana", sans-serif;
			}
        </style>
		<script>
			var current_zoom = 11;
		</script>
		<script src="markerdata.js"></script>
    </head>

    <body>
		<div id="header"><strong>UKz14</strong> at <strong id="zoomlevel"></strong></div>
        <div id="map"></div>

        <script>
            var map = L.map('map').setView([54.75, -1.50], current_zoom);

			function makemarker(feature, latlng, colour) {
				return L.circleMarker(latlng, {radius: 6, color: colour, opacity: 0.7, weight: 3,
					fill: true, fillOpacity: 0.0}).bindPopup("<strong><a href=" + feature.properties.website + ">" + feature.properties.name + "</a></strong>");
			};
			function makeimagemarker(feature, latlng, colour) {
				return L.circleMarker(latlng, {radius: 6, color: colour, opacity: 0.7, weight: 3,
					fill: true, fillOpacity: 0.0}).bindPopup("<strong><a href=" + encodeURI(feature.properties.bestlink) + ">" + feature.properties.source + "</a></strong>");
			};

			function ensuredata(layer) {
				if (layer.missingdata) {
					layer.addData(amenityData);
					layer.missingdata = false;
				}
			};
			function ensureimagedata(layer) {
				if (layer.missingdata) {
					layer.addData(imageData);
					layer.missingdata = false;
				}
			};
            var publayer = L.geoJSON(null, {
				pointToLayer: function(feature, latlng) { return makemarker(feature, latlng, 'red'); },
				filter: function(feature) { return (feature.properties.amenity == 'pub') || (feature.properties.amenity == 'hotel'); },
			}).on('add', function(e) { ensuredata(publayer); });
			publayer.missingdata = true;
            var cafelayer = L.geoJSON(null, {
				pointToLayer: function(feature, latlng) { return makemarker(feature, latlng, 'green'); },
				filter: function(feature) { return feature.properties.amenity == 'cafe'; },
			}).on('add', function(e) { ensuredata(cafelayer); });
			cafelayer.missingdata = true;
            var imagelayer = L.geoJSON(null, {
				pointToLayer: function(feature, latlng) { return makeimagemarker(feature, latlng, 'blue'); }
			}).on('add', function(e) { ensureimagedata(imagelayer); });
			imagelayer.missingdata = true;
			var overlayMaps = { "Pubs": publayer, "Cafes": cafelayer, "Images": imagelayer };
			var layerControl = L.control.layers(null, overlayMaps, {collapsed: false, position: 'topleft'}).addTo(map);
			function updatezoom() {
				current_zoom = map.getZoom();
				document.getElementById("zoomlevel").innerHTML = "Z" + current_zoom;
			}

            L.tileLayer('http://80.229.222.125/osm-tiles@1p5x/{z}/{x}/{y}.png', {
		minZoom: 8,
                maxZoom: 19,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors; OS Terrain 50 contours &copy; Crown Copyright (2023)',
                id: 'base'
            }).addTo(map);

			updatezoom()
			map.on('zoomend', updatezoom);
        </script>
    </body>
</html>
